<!doctype html><html lang=zh-cn><head><meta charset=utf-8><title>MongoDb + mongoose 个人整理 | wuxingtao Blog</title><meta name=viewport content="width=device-width,user-scalable=no,maximum-scale=1,initial-scale=1"><link rel=canonical href=https://www.xingtao.ga/posts/server-mongodb_mongoose-person-setting/><link rel=stylesheet href="https://fonts.loli.net/icon?family=Material+Icons"><link href=//cdn.bootcss.com/highlight.js/10.0.0/styles/atom-one-dark.min.css rel=stylesheet><link rel=stylesheet href=https://www.xingtao.ga/css/index.css><link rel=stylesheet href=https://www.xingtao.ga/css/custom.css><link href=https://www.xingtao.ga/index.xml rel=alternate type=application/rss+xml title="wuxingtao Blog"><link href=https://www.xingtao.ga/index.xml rel=feed type=application/rss+xml title="wuxingtao Blog"><link href=https://www.xingtao.ga/favicon.ico rel="shortcut icon"><script>window.baseURL='https:\/\/www.xingtao.ga';</script></head><body><div class=navbar-fixed><nav class=navbar><div class="nav-container container"><div class="nav-wrapper inner"><a href=javascript:void(0) data-activates=sidebar class="button-collapse hide-on-large-only"><i class=material-icons>menu</i></a>
<a href=https://www.xingtao.ga class=brand-logo><i class="material-icons hide-on-med-and-down">restaurant_menu</i>
wuxingtao Blog</a><ul class="nav-menu tabs tabs-transparent hide-on-med-and-down"><li class=tab><a href=https://www.xingtao.ga/>Home</a></li><li class=tab><a href=https://www.xingtao.ga/archive/>Archive</a></li><li class=tab><a href=https://www.xingtao.ga/about/>About</a></li></ul><form class="nav-form hide-on-small-and-down"><div class=form-group><i class=material-icons>search</i>
<input type=text placeholder=输入搜索关键字></div><div class=form-popout><div class=search-result><label>暂无搜索结果</label><ul></ul></div></div></form><ul class="nav-menu apps"><li><a class="search-btn hide-on-med-and-up" href=#search-panel><i class=material-icons>search</i></a></li><li><a class="term-btn hide-on-small-and-down" href=#term-panel><i class=material-icons>apps</i></a></li><li><a class="rss-btn hide-on-small-and-down" href=https://www.xingtao.ga/index.xml target=_blank><i class=material-icons>rss_feed</i></a></li></ul></div></div></nav></div><div class="mobile-search hide-on-med-and-up"><div class=header><i class=material-icons>search</i>
<input type=text placeholder=输入搜索关键字>
<i class="material-icons mobile-search-close">cancel</i></div><div class=content><label>暂无搜索结果</label><ul></ul></div></div><div class=taxonomy><div class=container><div class=inner><div class=taxonomy-panel><div class=group><label>Category</label><ul><li><a class="btn btn-secondary" href=https://www.xingtao.ga/categories/summary>summary
<span class=badge>10</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/categories/node>node
<span class=badge>2</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/categories/tao>tao
<span class=badge>1</span></a></li></ul></div><div class=group><label>Tag</label><ul><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/summary>summary
<span class=badge>5</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/javascript>javascript
<span class=badge>3</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/node>node
<span class=badge>2</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/ajax>ajax
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/development>development
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/express>express
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/git>git
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/go>go
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/golang>golang
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/hack>hack
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/html>html
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/hugo>hugo
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/mongodb>mongodb
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/react>react
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/regexp>regexp
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/seajs>seajs
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/templates>templates
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/theme>theme
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/themes>themes
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/typescript>typescript
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/vscode>vscode
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/vue>vue
<span class=badge>1</span></a></li><li><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/webstorm>webstorm
<span class=badge>1</span></a></li></ul></div></div></div></div></div><ul class=side-nav id=sidebar><li><a href=https://www.xingtao.ga/>Home</a></li><li><a href=https://www.xingtao.ga/archive/>Archive</a></li><li><a href=https://www.xingtao.ga/about/>About</a></li><li><a class="term-btn-mobile hide-on-med-only" href=https://www.xingtao.ga/categories/>Categories</a></li><li><a class="term-btn-mobile hide-on-med-only" href=https://www.xingtao.ga/tags/>Tags</a></li><li><a class="rss-btn-mobile hide-on-med-only" href=https://www.xingtao.ga/index.xml target=_blank>Rss</a></li></ul><main id=single role=main class=main-panel><div class=page-content><div class="container container-ex"><div class=inner><section class=post-wrapper><div class=toc-panel><nav id=TableOfContents><ul><li><a href=#连接mongodb>连接mongodb</a></li><li><a href=#定义一个schema>定义一个schema</a></li><li><a href=#sub-docs>Sub Docs</a></li><li><a href=#名词解释>名词解释</a></li><li><a href=#可视化工具--robo-3trobomongo>可视化工具- Robo 3T(Robomongo)</a></li><li><a href=#mongodb-操作>mongoDB 操作</a><ul><li><a href=#mongodb-数据库操作----备份-还原-导出-导入>mongodb 数据库操作 &ndash; 备份 还原 导出 导入</a></li></ul></li></ul></nav></div><div class="post reveal"><div class=card><section class=breadcrumb-root><div class=breadcrumbs role=navigation aria-label="breadcrumbs navigation"><a class=breadcrumb href=https://www.xingtao.ga><i class=material-icons>location_on</i>Home</a>
<span class=breadcrumb>MongoDb + mongoose 个人整理</span></div></section><div class="card-header postinfo"><span class=card-title>MongoDb + mongoose 个人整理</span></div><div class="card-header date"><div class=group><i class=material-icons>flag</i>
<time>创建：2017年01月 5日</time></div></div><div class=card-content><article class=article><h2 id=连接mongodb>连接mongodb</h2><pre><code>var mongoose = require('mongoose');
mongoose.connect('mongodb://admin:password@host:port/dbname');
//test
connectionString = 'mongodb://localhost/Node-tao',
</code></pre><h2 id=定义一个schema>定义一个schema</h2><pre><code>new Schema({..}, options);
</code></pre><p>###Note that if the resulting record is converted to an object or JSON, virtuals are not included by default. Passvirtuals : true to either toObject() or to toJSON() to have them returned.</p><pre><code>// 虚拟属性开关，true:支持
var ContentSchema = new mongoose.Schema({
    name:String,   //定义一个属性name，类型为String
    updateDate: {
        type: Date,
        default: Date.now
    }
 },{toJSON:{virtuals: true}});
//定义虚拟属性
ContentSchema.virtual('created_day').get(function() {
    return moment(this.updateDate).format('YYYY-MM-DD');
})
</code></pre><h2 id=sub-docs>Sub Docs</h2><pre><code> var ChildSchema1 = new Schema({name:String});
 var ChildSchema2 = new Schema({name:String});
 var ParentSchema = new Schema({
   children1:ChildSchema1,   //嵌套Document
   children2:[ChildSchema2]  //嵌套Documents
    });
</code></pre><h2 id=名词解释>名词解释</h2><p>exec(cb) 意义？
cb是callback的意思,exec(cb)即执行完后将调用callback函数,你可以传一个函数进去,例如:</p><pre><code>db.collection.find(&quot;xxx&quot;).exec(function(err,doc){
    console.log(doc);
});
</code></pre><p> 
ref 表示表collection关联
ref表示关联Post(注意: 被关联的model的 type 必须是 ObjectId, Number, String, 和 Buffer 才有效)。</p><pre><code>var mongoose = require('mongoose');
var Schema   = mongoose.Schema;
 
var UserSchema = new Schema({
    name  : { type: String, unique: true },
    posts : [{ type: Schema.Types.ObjectId, ref: 'Post' }]
});
var User = mongoose.model('User', UserSchema);
 
var PostSchema = new Schema({
    poster   : { type: Schema.Types.ObjectId, ref: 'User' },
    comments : [{ type: Schema.Types.ObjectId, ref: 'Comment' }],
    title    : String,
    content  : String
});
var Post = mongoose.model('Post', PostSchema);
 
var CommentSchema = new Schema({
    post      : { type: Schema.Types.ObjectId, ref: &quot;Post&quot; },
    commenter : { type: Schema.Types.ObjectId, ref: 'User' },
    content   : String
});
var Comment = mongoose.model('Comment', CommentSchema);
在上述的例子中，创建了三个 Models:User，Post，Comment。
User 的属性 posts，对应是一个 ObjectId 的数组。ref表示关联Post(注意: 被关联的model的 type 必须是 ObjectId, Number, String, 和 Buffer 才有效)。
Post的属性 poster 和 comments 分别关联User和Comment。
Comment的属性 post 和 commenter 分别关联Post和User。
三个 Models 的关系:一个 user--has many--&gt;post。一个 post--has one--&gt;user，has many--&gt;comment。一个 comment--has one--&gt;post 和 user。
</code></pre><h2 id=可视化工具--robo-3trobomongo>可视化工具- Robo 3T(Robomongo)</h2><h2 id=mongodb-操作>mongoDB 操作</h2><h3 id=mongodb-数据库操作----备份-还原-导出-导入>mongodb 数据库操作 &ndash; 备份 还原 导出 导入</h3><p>1.mongodump备份数据库</p><blockquote><p>mongodump -h IP &ndash;port 端口 -u 用户名 -p 密码 -d 数据库 -o 文件存在路径
如果没有用户谁，可以去掉-u和-p。
如果导出本机的数据库，可以去掉-h。
如果是默认端口，可以去掉&ndash;port。
如果想导出所有数据库，可以去掉-d。</p></blockquote><p><code>mongodump -h 127.0.0.1 -o E:\mongoData</code> -导出所有数据库</p><p><code>mongodump -h 127.0.0.1 -d nodetao -o E:\mongoData</code> -导出指定数据库 -d</p><p>2.mongorestore还原数据库</p><blockquote><p>mongorestore -h IP &ndash;port 端口 -u 用户名 -p 密码 -d 数据库 &ndash;drop 文件存在路径
&ndash;drop的意思是，先删除所有的记录，然后恢复。</p></blockquote><p>3.mongoexport导出表，或者表中部分字段
格式：</p><blockquote><p>mongoexport -h IP &ndash;port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 -f 字段 -q 条件导出 &ndash;csv -o 文件名</p></blockquote><p>上面的参数好理解，重点说一下：
-f 导出指字段，以字号分割，-f name,email,age导出name,email,age这三个字段</p><p>-q 可以根查询条件导出，-q &lsquo;{ &ldquo;uid&rdquo; : &ldquo;100&rdquo; }&rsquo; 导出uid为100的数据</p><p>&ndash;csv 表示导出的文件格式为csv的，这个比较有用，因为大部分的关系型数据库都是支持csv，在这里有共同点</p><p>4.mongoimport导入表，或者表中部分字段</p><p>1.1,还原整表导出的非csv文件</p><p><code>mongoimport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 --upsert --drop 文件名</code>
重点说一下&ndash;upsert，其他参数上面的命令已有提到，&ndash;upsert 插入或者更新现有数据</p><p>1.2,还原部分字段的导出文件</p><p><code>mongoimport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 --upsertFields 字段 --drop 文件名</code>
&ndash;upsertFields根&ndash;upsert一样</p><p>1.3,还原导出的csv文件</p><p><code>mongoimport -h IP --port 端口 -u 用户名 -p 密码 -d 数据库 -c 表名 --type 类型 --headerline --upsert</code> &ndash;drop 文件名</p><blockquote><a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/><img alt=知识共享许可协议 style=border-width:0 src=https://i.creativecommons.org/l/by-nc/4.0/88x31.png></a><br>本作品采用<a rel=license href=http://creativecommons.org/licenses/by-nc/4.0/>知识共享署名-非商业性使用 4.0 国际许可协议</a>进行许可。</blockquote></article></div><div class="card-action card-action-links"><a class="btn btn-secondary" href=https://www.xingtao.ga/tags/mongodb>mongoDB</a></div><div class=card-action></div><div class=pagination-single><span class="pagination-item previous"><i class=material-icons>navigate_before</i>
<a href=https://www.xingtao.ga/posts/summary-hack-person-setting/ rel=prev>【hack】个人整理</a></span>
<span class="pagination-item next"><a href=https://www.xingtao.ga/posts/summary-node-express-params/ rel=next>Node-express 数据传递【个人整理】</a>
<i class=material-icons>navigate_next</i></span></div></div></div></section></div></div></div><footer class=page-footer><div class=container><div class=inner><div class=wrapper><div class="group group-slink"><h5>wuxingtao Blog</h5><ul class=slink><li><a href=https://github.com/wuxingtao target=_blank title=Github><svg class="svg-icons svg-icons-github"><use xlink:href="#svg-icons-github"/></svg></a></li><li><a href=https://twitter.com/wuxingtao target=_blank title=Twitter><svg class="svg-icons svg-icons-twitter"><use xlink:href="#svg-icons-twitter"/></svg></a></li></ul></div><div class="group group-flink"><h5>My Friends</h5><ul></ul></div></div></div></div><div class=footer-copyright><div class=container><div class=inner>Copyleft@wuxingtao</div></div></div><script>var cnzz_s_tag=document.createElement('script');cnzz_s_tag.type='text/javascript';cnzz_s_tag.async=true;cnzz_s_tag.charset='utf-8';cnzz_s_tag.src='https://s9.cnzz.com/z_stat.php?id=1278688351&web_id=1278688351';var root_s=document.getElementsByTagName('script')[0];root_s.parentNode.insertBefore(cnzz_s_tag,root_s);</script></footer></main><script type=text/javascript async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_CHTML"></script><script type=text/javascript src=//cdn.bootcss.com/highlight.js/10.0.0/highlight.min.js></script><script src=https://cdn.bootcss.com/highlight.js/10.0.0/languages/go.min.js></script><script src=https://cdn.bootcdn.net/ajax/libs/highlight.js/10.0.0/languages/javascript.min.js></script><script src=https://cdn.bootcss.com/highlight.js/10.0.0/languages/typescript.min.js></script><script>hljs.configure({tabReplace:'  '})
hljs.registerLanguage("graphql",function(e){return{aliases:["gql"],k:{keyword:"query mutation subscription|10 type interface union scalar fragment|10 enum on ...",literal:"true false null"},c:[e.HCM,e.QSM,e.NM,{cN:"type",b:"[^\\w][A-Z][a-z]",e:"\\W",eE:!0},{cN:"literal",b:"[^\\w][A-Z][A-Z]",e:"\\W",eE:!0},{cN:"variable",b:"\\$",e:"\\W",eE:!0},{cN:"keyword",b:"[.]{2}",e:"\\."},{cN:"meta",b:"@",e:"\\W",eE:!0}],i:/([;<']|BEGIN)/}});hljs.initHighlightingOnLoad();</script><script type=text/javascript src=https://www.xingtao.ga/js/polyfill.js></script><script type=text/javascript src=https://www.xingtao.ga/js/index.js></script></body></html>